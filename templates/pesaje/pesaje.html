{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4">Registro de Peso</h2>

    <!-- Información General Mejorada -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información General</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Columna Izquierda: Proveedor y Guía -->
                <div class="col-lg-6 mb-3 mb-lg-0">
                    <dl class="row mb-0">
                        <dt class="col-sm-5"><i class="fas fa-user me-1 text-primary"></i>Código Proveedor:</dt>
                        <dd class="col-sm-7">{{ datos.codigo }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-id-card me-1 text-primary"></i>Nombre Proveedor:</dt>
                        <dd class="col-sm-7">{{ datos.nombre_proveedor }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-barcode me-1 text-primary"></i>Código Guía:</dt>
                        <dd class="col-sm-7">{{ datos.codigo_guia }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-calendar-alt me-1 text-primary"></i>Fecha/Hora Entrada:</dt>
                        <dd class="col-sm-7">{{ datos.timestamp_registro_utc | format_datetime if datos.timestamp_registro_utc else 'N/A' }}</dd>
                        
                        <dt class="col-sm-5"><i class="fas fa-project-diagram me-1 text-primary"></i>Tipo de Guía:</dt>
                        <dd class="col-sm-7">
                            {% if datos.is_madre is defined and datos.is_madre %}
                                <span class="badge bg-warning text-dark">Madre</span>
                            {% elif datos.is_madre is defined and not datos.is_madre %}
                                <span class="badge bg-secondary">Normal</span>
                            {% else %}
                                <span class="badge bg-light text-muted">No disponible</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
                <!-- Columna Derecha: Detalles y Guías Hijas -->
                <div class="col-lg-6">
                    <dl class="row mb-0">
                        <dt class="col-sm-5"><i class="fas fa-calendar-check me-1 text-secondary"></i>Fecha/Hora Pesaje:</dt>
                        <dd class="col-sm-7">{{ datos.timestamp_pesaje_utc | format_datetime if datos.timestamp_pesaje_utc else 'Pendiente' }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-boxes me-1 text-secondary"></i>Racimos:</dt>
                        <dd class="col-sm-7">{{ datos.cantidad_racimos }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-truck-loading me-1 text-secondary"></i>Se Cargó:</dt>
                        <dd class="col-sm-7">{{ datos.cargo }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-truck-moving me-1 text-secondary"></i>Se Acarreó:</dt>
                        <dd class="col-sm-7">{{ datos.acarreo }}</dd>

                        <dt class="col-sm-5"><i class="fas fa-id-badge me-1 text-secondary"></i>Transportista:</dt>
                        <dd class="col-sm-7">{{ datos.transportista }}</dd>
                    </dl>
                    
                    {% if datos.is_madre is defined and datos.is_madre and datos.hijas_str is defined and datos.hijas_str %}
                    <div class="mt-3 border-top pt-3">
                        <h6 class="mb-2"><i class="fas fa-sitemap me-1 text-warning"></i>Guías Hijas Asociadas:</h6>
                        <pre class="bg-light p-2 rounded" style="white-space: pre-wrap; font-size: 0.9em;">{{ datos.hijas_str }}</pre>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Pesaje -->
    <div class="classification-section">
        <h4 class="mb-3">Tipo de Pesaje</h4>
        <div class="mb-3">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="tipo_pesaje" id="pesaje_foto" value="foto" checked>
                <label class="btn btn-outline-primary" for="pesaje_foto">Pesaje Soporte Foto</label>
                
                <input type="radio" class="btn-check" name="tipo_pesaje" id="pesaje_manual" value="manual">
                <label class="btn btn-outline-primary" for="pesaje_manual">Pesaje Manual</label>
                
                <input type="radio" class="btn-check" name="tipo_pesaje" id="pesaje_pepa" value="pepa">
                <label class="btn btn-outline-primary" for="pesaje_pepa">Pesaje Pepa</label>
            </div>
        </div>
        
        <!-- Sección de Pesaje Soporte Foto (antes Directo) -->
        <div id="seccion_pesaje_foto" class="mt-4">
            <div class="mb-3">
                <label class="form-label">Capturar o Subir Peso</label>
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-primary" id="btn_capturar">
                        <i class="fas fa-camera"></i> Capturar con Cámara
                    </button>
                    <div class="btn btn-primary position-relative">
                        <i class="fas fa-upload"></i> Subir Foto
                        <input type="file" id="input_foto" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                               accept="image/*" style="cursor: pointer;">
                    </div>
                    <button class="btn btn-info" id="btn_capturar_pantalla">
                        <i class="fas fa-desktop"></i> Capturar Pantalla
                    </button>
                    <button class="btn btn-secondary" id="btn_recapturar" style="display: none;">
                        <i class="fas fa-redo"></i> Reintentar
                    </button>
                </div>
            </div>
            
            <div id="preview_container" class="mb-3" style="display: none;">
                <img id="preview_image" class="img-fluid rounded" style="max-width: 400px;">
                <div class="mt-2">
                    <button class="btn btn-primary" id="btn_validar_foto">
                        <i class="fas fa-check"></i> Validar Foto
                    </button>
                </div>
            </div>
            
            <div id="peso_detectado_container" class="mb-3 alert alert-success" style="display: none;">
                <h5 class="mb-0">Peso Detectado: <span id="peso_detectado"></span> kg</h5>
            </div>
        </div>
        
        <!-- Sección de Pesaje Manual (antes Virtual) -->
        <div id="seccion_pesaje_manual" class="mt-4" style="display: none;">
            <!-- Paso 1: Solicitud de Autorización -->
            <div id="paso_solicitud" class="mb-3">
                <label class="form-label">Justificación para Pesaje Manual</label>
                <textarea class="form-control mb-2" id="justificacion" rows="3" placeholder="Explique por qué se requiere pesaje manual"></textarea>
                <button class="btn btn-primary" id="btn_solicitar_autorizacion">
                    <i class="fas fa-paper-plane"></i> Solicitar Autorización
                </button>
            </div>
            
            <!-- Paso 2: Validación de Código -->
            <div id="paso_validacion" class="mb-3" style="display: none;">
                <label class="form-label">Código de Autorización</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="codigo_autorizacion" placeholder="Ingrese el código">
                    <button class="btn btn-primary" id="btn_validar_codigo">
                        <i class="fas fa-check"></i> Validar
                    </button>
                </div>
            </div>
            
            <!-- Paso 3: Ingreso de Peso -->
            <div id="paso_peso_virtual" class="mb-3" style="display: none;">
                <label class="form-label">Peso Bruto (kg)</label>
                <input type="number" class="form-control mb-2" id="peso_virtual" step="0.001" placeholder="Ingrese el peso">

                <label class="form-label">Código Guía SAP (Opcional)</label>
                <input type="text" class="form-control" id="codigo_guia_sap_manual" placeholder="Ingrese el código SAP">
            </div>
        </div>
        
        <!-- Sección de Pesaje Pepa (antes Directo) -->
        <div id="seccion_pesaje_pepa" class="mt-4" style="display: none;">
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Este pesaje es específico para el producto PEPA. Use "Validación Foto" para procesar la imagen de la báscula.
            </div>
            
            <!-- Nuevos botones para Pepa -->
            <div class="mb-3 d-flex gap-2">
                <!-- El botón Validación Foto ahora está abajo, junto a la lógica de captura -->
                
                <!-- Botón para procesar/guardar el peso de Pepa -->
                <button class="btn btn-warning" id="btn_procesar_pepa" style="display: none;">
                    <i class="fas fa-save me-2"></i> Procesar Peso Pepa
                </button>
            </div>
            
            <!-- **** INICIO: Estructura copiada de Pesaje Soporte Foto **** -->
            <div class="mb-3">
                <label class="form-label">Capturar o Subir Peso (Pepa)</label>
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-primary" id="btn_capturar_pepa">
                        <i class="fas fa-camera"></i> Capturar con Cámara
                    </button>
                    <div class="btn btn-primary position-relative">
                        <i class="fas fa-upload"></i> Subir Foto
                        <input type="file" id="input_foto_pepa" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                               accept="image/*" style="cursor: pointer;">
                    </div>
                    <!-- Nuevo botón para captura de pantalla (Pepa) -->
                    <button class="btn btn-info" id="btn_capturar_pantalla_pepa">
                        <i class="fas fa-desktop"></i> Capturar Pantalla
                    </button>
                    <button class="btn btn-secondary" id="btn_recapturar_pepa" style="display: none;">
                        <i class="fas fa-redo"></i> Reintentar (Pepa)
                    </button>
                </div>
            </div>
            
            <div id="preview_container_pepa" class="mb-3" style="display: none;">
                <img id="preview_image_pepa" class="img-fluid rounded" style="max-width: 400px;">
                <div class="mt-2">
                    <button class="btn btn-primary" id="btn_validacion_foto_pepa">
                        <i class="fas fa-check"></i> Validar Foto (Pepa)
                    </button>
                </div>
            </div>
            
            <div id="peso_detectado_container_pepa" class="mb-3 alert alert-success" style="display: none;">
                <h5 class="mb-0">Peso Detectado (Pepa): <span id="peso_detectado_pepa"></span> kg</h5>
            </div>
             <!-- **** FIN: Estructura copiada de Pesaje Soporte Foto **** -->

            
            <!-- Elementos existentes de la sección anterior (deshabilitados/informativos por ahora) -->
            
            <div id="peso_pepa_container" class="mb-3 alert alert-success" style="display: none;">
                <h5 class="mb-0">Peso Recibido Pepa: <span id="peso_pepa_valor"></span> kg</h5>
            </div>
        </div>
        
        <!-- Sección de Fotos de Soporte -->
        <div class="mt-4 mb-4">
            <h4 class="mb-3 d-flex justify-content-between align-items-center">
                <span>Fotos de Soporte (Opcional)</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle_fotos_soporte">
                    <i class="fas fa-eye me-1"></i> Mostrar
                </button>
            </h4>
            <!-- Envolver contenido en div oculto -->
            <div id="contenedor_fotos_soporte" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Adjunte fotos del camión en la báscula como evidencia del pesaje (máximo 4 fotos).
                </div>
                <div class="row">
                    <!-- Foto 1 -->
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Foto 1</h5>
                                <div class="mb-2">
                                    <div class="btn btn-primary position-relative w-100">
                                        <i class="fas fa-upload me-2"></i> Subir Foto
                                        <input type="file" id="foto_soporte_1" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                           accept="image/*" style="cursor: pointer;">
                                    </div>
                                </div>
                                <div id="preview_foto_1" class="text-center" style="display: none;">
                                    <img class="img-fluid rounded mb-2 preview-image" alt="Vista previa foto 1">
                                    <button type="button" class="btn btn-danger btn-sm w-100 btn-remove-foto" data-foto="1">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Foto 2 -->
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Foto 2</h5>
                                <div class="mb-2">
                                    <div class="btn btn-primary position-relative w-100">
                                        <i class="fas fa-upload me-2"></i> Subir Foto
                                        <input type="file" id="foto_soporte_2" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                           accept="image/*" style="cursor: pointer;">
                                    </div>
                                </div>
                                <div id="preview_foto_2" class="text-center" style="display: none;">
                                    <img class="img-fluid rounded mb-2 preview-image" alt="Vista previa foto 2">
                                    <button type="button" class="btn btn-danger btn-sm w-100 btn-remove-foto" data-foto="2">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Foto 3 -->
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Foto 3</h5>
                                <div class="mb-2">
                                    <div class="btn btn-primary position-relative w-100">
                                        <i class="fas fa-upload me-2"></i> Subir Foto
                                        <input type="file" id="foto_soporte_3" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                           accept="image/*" style="cursor: pointer;">
                                    </div>
                                </div>
                                <div id="preview_foto_3" class="text-center" style="display: none;">
                                    <img class="img-fluid rounded mb-2 preview-image" alt="Vista previa foto 3">
                                    <button type="button" class="btn btn-danger btn-sm w-100 btn-remove-foto" data-foto="3">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Foto 4 -->
                    <div class="col-md-3 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Foto 4</h5>
                                <div class="mb-2">
                                    <div class="btn btn-primary position-relative w-100">
                                        <i class="fas fa-upload me-2"></i> Subir Foto
                                        <input type="file" id="foto_soporte_4" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                           accept="image/*" style="cursor: pointer;">
                                    </div>
                                </div>
                                <div id="preview_foto_4" class="text-center" style="display: none;">
                                    <img class="img-fluid rounded mb-2 preview-image" alt="Vista previa foto 4">
                                    <button type="button" class="btn btn-danger btn-sm w-100 btn-remove-foto" data-foto="4">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sección de Verificación de Placa -->
        <div class="mt-4 mb-4">
            <h4 class="mb-3 d-flex justify-content-between align-items-center">
                <span>Verificación de Placa</span>
                 <button class="btn btn-sm btn-outline-secondary" type="button" id="toggle_verificacion_placa">
                    <i class="fas fa-eye me-1"></i> Mostrar
                </button>
            </h4>
            <!-- Envolver contenido en div oculto -->
            <div id="contenedor_verificacion_placa" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Tome una foto de la placa del vehículo para verificar que coincida con la placa registrada inicialmente.
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Foto de la Placa</h5>
                                <p class="card-text">Placa registrada: <strong>{{ datos.placa }}</strong></p>
                                <div class="mb-3">
                                    <div class="btn btn-primary position-relative">
                                        <i class="fas fa-camera me-2"></i> Capturar Placa
                                        <input type="file" id="placa_foto" class="position-absolute top-0 start-0 opacity-0 w-100 h-100" 
                                               accept="image/*" style="cursor: pointer;">
                                    </div>
                                    <button class="btn btn-success ms-2" id="btn_verificar_placa" disabled>
                                        <i class="fas fa-check me-2"></i> Verificar Placa
                                    </button>
                                </div>
                                <div id="preview_placa" class="text-center" style="display: none;">
                                    <img class="img-fluid rounded mb-2" alt="Vista previa placa">
                                    <button type="button" class="btn btn-danger btn-sm" id="btn_eliminar_placa">
                                        <i class="fas fa-trash-alt me-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="resultado_placa" style="display: none;">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Resultado de la Verificación</h5>
                                    <div id="placa_detectada" class="mb-2">
                                        <span class="fw-bold">Placa detectada:</span> <span id="texto_placa_detectada"></span>
                                    </div>
                                    <div id="placa_coincide" class="alert alert-success" style="display: none;">
                                        <i class="fas fa-check-circle me-2"></i> La placa coincide con la registrada inicialmente.
                                    </div>
                                    <div id="placa_no_coincide" class="alert alert-danger" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i> La placa NO coincide con la registrada inicialmente.
                                    </div>
                                    <div id="placa_error" class="alert alert-warning" style="display: none;">
                                        <i class="fas fa-exclamation-circle me-2"></i> <span id="texto_error_placa"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botón de Procesar -->
        <div class="text-center mt-4">
            <button class="btn btn-success" id="btn_procesar" style="display: none;">
                <i class="fas fa-save"></i> Procesar Peso
            </button>
        </div>
    </div>
</div>

<!-- Overlay de carga -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Procesando...</span>
        </div>
        <h2 class="mt-3">Procesando validación...</h2>
        <p>Por favor espere mientras validamos la foto.</p>
    </div>
</div>

<style>
    .info-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .classification-section {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-content {
        text-align: center;
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .loading-content h2 {
        margin-top: 1rem;
        font-size: 1.5rem;
        color: #0d6efd;
    }
    .loading-content p {
        color: #6c757d;
        margin-top: 0.5rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoPesajeRadios = document.querySelectorAll('input[name="tipo_pesaje"]');
    const seccionFoto = document.getElementById('seccion_pesaje_foto');
    const seccionManual = document.getElementById('seccion_pesaje_manual');
    const seccionPepa = document.getElementById('seccion_pesaje_pepa');
    const btnProcesar = document.getElementById('btn_procesar');
    let pesoCapturado = null;
    let imagenActual = null;
    let fotoBascula = null;
    let sapCodeFromValidation = null;
    let imagenActualPepa = null; // Variable para la imagen de la sección Pepa
    let pesoDetectadoPepaValor = null; // Variable para guardar el peso detectado para Pepa
    
    // Función para capturar imagen con la cámara
    async function capturarImagen() {
        // ... existing code ...
    }
    
    tipoPesajeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'foto') {
                seccionFoto.style.display = 'block';
                seccionManual.style.display = 'none';
                seccionPepa.style.display = 'none';
            } else if (this.value === 'manual') {
                seccionFoto.style.display = 'none';
                seccionManual.style.display = 'block';
                seccionPepa.style.display = 'none';
            } else {
                seccionFoto.style.display = 'none';
                seccionManual.style.display = 'none';
                seccionPepa.style.display = 'block';
            }
            btnProcesar.style.display = 'none';
            pesoCapturado = null;
        });
    });
    
    // Pesaje Soporte Foto
    const btnCapturar = document.getElementById('btn_capturar');
    const inputFoto = document.getElementById('input_foto');
    const btnRecapturar = document.getElementById('btn_recapturar');
    const previewContainer = document.getElementById('preview_container');
    const previewImage = document.getElementById('preview_image');
    const pesoDetectadoContainer = document.getElementById('peso_detectado_container');
    const pesoDetectadoSpan = document.getElementById('peso_detectado');
    const btnValidarFoto = document.getElementById('btn_validar_foto');
    
    // Función para mostrar la imagen
    function mostrarImagen(blob) {
        previewImage.src = URL.createObjectURL(blob);
        previewContainer.style.display = 'block';
        btnCapturar.style.display = 'none';
        inputFoto.parentElement.style.display = 'none';
        btnRecapturar.style.display = 'block';
        pesoDetectadoContainer.style.display = 'none';
        imagenActual = blob;
    }

    function mostrarCarga(visible) {
        document.getElementById('loadingOverlay').style.display = visible ? 'flex' : 'none';
    }
    
    // Botón para capturar con cámara
    btnCapturar.addEventListener('click', capturarImagen);
    
    // Input para subir foto
    inputFoto.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            mostrarImagen(this.files[0]);
        }
    });
    
    // Botón para recapturar
    btnRecapturar.addEventListener('click', function() {
        previewContainer.style.display = 'none';
        btnCapturar.style.display = 'block';
        inputFoto.parentElement.style.display = 'block';
        btnRecapturar.style.display = 'none';
        pesoDetectadoContainer.style.display = 'none';
        imagenActual = null;
        pesoCapturado = null;
        btnProcesar.style.display = 'none';
    });
    
    // Evento para validar foto
    btnValidarFoto.addEventListener('click', async function() {
        if (!imagenActual) {
            alert('Por favor, capture o suba una imagen primero');
            return;
        }
        
        // Mostrar el overlay de carga
        mostrarCarga(true);
        
        try {
            const formData = new FormData();
            formData.append('imagen', imagenActual);
            formData.append('codigo_guia', '{{ datos.codigo_guia }}');
            
            const response = await fetch('/pesaje/procesar_pesaje_directo', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                pesoDetectadoSpan.textContent = data.peso;
                pesoDetectadoContainer.style.display = 'block';
                pesoCapturado = data.peso;
                fotoBascula = imagenActual;
                sapCodeFromValidation = data.codigo_guia_transporte_sap;
                btnProcesar.style.display = 'block';
                // alert('Validación exitosa. Peso detectado correctamente.');
            } else {
                pesoDetectadoContainer.style.display = 'none';
                btnProcesar.style.display = 'none';
                alert(data.message || 'Error al procesar la imagen');
            }
        } catch (error) {
            console.error(error);
            alert('Error al procesar la imagen: ' + error.message);
        } finally {
            // Ocultar el overlay de carga
            mostrarCarga(false);
        }
    });
    
    // Pesaje Virtual
    const btnSolicitarAutorizacion = document.getElementById('btn_solicitar_autorizacion');
    const pasoValidacion = document.getElementById('paso_validacion');
    const btnValidarCodigo = document.getElementById('btn_validar_codigo');
    const pasoPesoVirtual = document.getElementById('paso_peso_virtual');
    
    btnSolicitarAutorizacion.addEventListener('click', async function() {
        const justificacion = document.getElementById('justificacion').value;
        if (!justificacion) {
            alert('Por favor, ingrese una justificación');
            return;
        }
        
        try {
            // Mostrar mensaje de carga
            mostrarCarga(true);
            
            const response = await fetch('/pesaje/solicitar_autorizacion_pesaje', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    codigo_guia: '{{ datos.codigo_guia }}',
                    comentarios: justificacion
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Solicitud enviada correctamente. El código de autorización le será proporcionado por el personal autorizado.');
                pasoValidacion.style.display = 'block';
            } else {
                alert(data.message || 'Error al enviar la solicitud');
            }
        } catch (error) {
            console.error(error);
            alert('Error al enviar la solicitud: ' + error.message);
        } finally {
            // Ocultar mensaje de carga
            mostrarCarga(false);
        }
    });
    
    btnValidarCodigo.addEventListener('click', async function() {
        const codigo = document.getElementById('codigo_autorizacion').value;
        if (!codigo) {
            alert('Por favor, ingrese el código de autorización');
            return;
        }
        
        try {
            const response = await fetch('/pesaje/validar_codigo_autorizacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    codigo_guia: '{{ datos.codigo_guia }}',
                    codigoAutorizacion: codigo
                })
            });
            
            const data = await response.json();
            if (data.success) {
                pasoPesoVirtual.style.display = 'block';
                btnProcesar.style.display = 'block';
            } else {
                alert(data.message);
            }
        } catch (error) {
            console.error(error);
            alert('Error al validar el código');
        }
    });
    
    // Manejo de fotos de soporte
    let fotosSoporte = {
        foto1: null,
        foto2: null,
        foto3: null,
        foto4: null
    };
    
    // Inicializar los inputs de fotos
    for (let i = 1; i <= 4; i++) {
        const fotoInput = document.getElementById(`foto_soporte_${i}`);
        const previewDiv = document.getElementById(`preview_foto_${i}`);
        const previewImg = previewDiv.querySelector('img');
        
        fotoInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                    fotosSoporte[`foto${i}`] = file;
                };
                
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Manejar eliminación de fotos
    document.querySelectorAll('.btn-remove-foto').forEach(button => {
        button.addEventListener('click', function() {
            const fotoNum = this.getAttribute('data-foto');
            const previewDiv = document.getElementById(`preview_foto_${fotoNum}`);
            const fotoInput = document.getElementById(`foto_soporte_${fotoNum}`);
            
            previewDiv.style.display = 'none';
            fotoInput.value = '';
            fotosSoporte[`foto${fotoNum}`] = null;
        });
    });
    
    // Modificar el manejador del botón procesar para incluir las fotos
    btnProcesar.addEventListener('click', async function() {
        const tipoPesaje = document.querySelector('input[name="tipo_pesaje"]:checked').value;
        let pesoBruto;
        let endpointUrl;
        const formData = new FormData();
        formData.append('codigo_guia', '{{ datos.codigo_guia }}');

        // Mostrar el overlay de carga con mensaje personalizado
        const loadingContent = document.querySelector('.loading-content');
        const loadingTitle = loadingContent.querySelector('h2');
        const loadingText = loadingContent.querySelector('p');
        loadingTitle.textContent = 'Procesando peso...';
        loadingText.textContent = 'Por favor espere mientras registramos el peso.';
        mostrarCarga(true);

        try {
            if (tipoPesaje === 'foto') {
                pesoBruto = pesoCapturado; // Use the weight from validation
                if (!pesoBruto) {
                    alert('Error: No se ha validado un peso para la foto.');
                    mostrarCarga(false);
                    return;
                }
                if (!fotoBascula) { // fotoBascula should be set when validation succeeds
                    alert('Error: No se ha validado una imagen de báscula.');
                    mostrarCarga(false);
                    return;
                }
                formData.append('peso_bruto', pesoBruto);
                formData.append('tipo_pesaje', 'directo'); // Explicitly set type for backend
                formData.append('imagen', fotoBascula); // Use the validated image
                if (sapCodeFromValidation) {
                    formData.append('codigo_guia_transporte_sap', sapCodeFromValidation);
                }
                endpointUrl = '/pesaje/registrar_peso_directo'; // Endpoint for direct registration

            } else if (tipoPesaje === 'manual') {
                pesoBruto = document.getElementById('peso_virtual').value;
                const codigoGuiaSapManual = document.getElementById('codigo_guia_sap_manual').value; // LEER CÓDIGO SAP MANUAL
                 if (!pesoBruto) {
                    alert('Por favor, ingrese el peso manual.');
                    mostrarCarga(false);
                    return;
                }
                // Ensure authorization was completed if required
                if (pasoPesoVirtual.style.display === 'none') {
                     alert('Por favor, complete el proceso de autorización para el pesaje manual.');
                     mostrarCarga(false);
                     return;
                }
                formData.append('peso_bruto', pesoBruto);
                formData.append('tipo_pesaje', 'virtual'); // Explicitly set type
                // Add justification if needed by the endpoint
                formData.append('justificacion', document.getElementById('justificacion').value);
                if (codigoGuiaSapManual) { // AÑADIR CÓDIGO SAP SI ESTÁ PRESENTE
                    formData.append('codigo_guia_transporte_sap', codigoGuiaSapManual);
                }
                endpointUrl = '/pesaje/registrar_peso_virtual'; // Endpoint for virtual registration

            } else { // tipoPesaje === 'pepa'
                // Aquí irá la lógica futura para Pepa, por ahora no hace nada o muestra alerta
                alert('La funcionalidad de Pesaje Pepa aún no está completamente implementada para el guardado final en este paso.');
                mostrarCarga(false);
                return;
            }

            // Agregar las fotos de soporte si existen
            for (let i = 1; i <= 4; i++) {
                if (fotosSoporte[`foto${i}`]) {
                    formData.append(`foto_soporte_${i}`, fotosSoporte[`foto${i}`]);
                }
            }

            // Realizar la solicitud fetch
            const response = await fetch(endpointUrl, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Redireccionar a la URL proporcionada por el servidor
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.redirect) { // Handle older 'redirect' key if still used
                    window.location.href = data.redirect;
                } else {
                    // Fallback or show success message if no redirect provided
                    alert(data.message || 'Peso registrado correctamente, pero no se proporcionó redirección.');
                    window.location.href = '/'; // Example fallback redirect
                }
            } else {
                alert(data.message || 'Error al registrar el peso.');
            }

        } catch (error) {
            console.error(error);
            alert('Error al procesar el peso: ' + error.message);
        } finally {
            // Ocultar el overlay de carga
            mostrarCarga(false);
            // Restaurar el mensaje original del overlay
            loadingTitle.textContent = 'Procesando validación...';
            loadingText.textContent = 'Por favor espere mientras validamos la foto.';
        }
    });

    // ----- CÓDIGO PARA VERIFICACIÓN DE PLACA -----
    const placaFotoInput = document.getElementById('placa_foto');
    const previewPlaca = document.getElementById('preview_placa');
    const previewPlacaImg = previewPlaca.querySelector('img');
    const btnVerificarPlaca = document.getElementById('btn_verificar_placa');
    const btnEliminarPlaca = document.getElementById('btn_eliminar_placa');
    const resultadoPlaca = document.getElementById('resultado_placa');
    const textoPlacaDetectada = document.getElementById('texto_placa_detectada');
    const placaCoincide = document.getElementById('placa_coincide');
    const placaNoCoincide = document.getElementById('placa_no_coincide');
    const placaError = document.getElementById('placa_error');
    const textoErrorPlaca = document.getElementById('texto_error_placa');
    
    let placaFotoActual = null;
    let placaRegistrada = '{{ datos.placa }}';
    
    // Manejar carga de foto de placa
    placaFotoInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            const file = this.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                previewPlacaImg.src = e.target.result;
                previewPlaca.style.display = 'block';
                placaFotoActual = file;
                btnVerificarPlaca.disabled = false;
                
                // Ocultar resultados anteriores
                resultadoPlaca.style.display = 'none';
                placaCoincide.style.display = 'none';
                placaNoCoincide.style.display = 'none';
                placaError.style.display = 'none';
            };
            
            reader.readAsDataURL(file);
        }
    });
    
    // Manejar eliminación de foto de placa
    btnEliminarPlaca.addEventListener('click', function() {
        previewPlaca.style.display = 'none';
        placaFotoInput.value = '';
        placaFotoActual = null;
        btnVerificarPlaca.disabled = true;
        resultadoPlaca.style.display = 'none';
    });
    
    // Manejar verificación de placa
    btnVerificarPlaca.addEventListener('click', async function() {
        if (!placaFotoActual) {
            alert('Por favor, capture o suba una foto de la placa primero');
            return;
        }
        
        try {
            // Mostrar el overlay de carga
            mostrarCarga(true);
            
            const formData = new FormData();
            formData.append('placa_foto', placaFotoActual);
            formData.append('codigo_guia', '{{ datos.codigo_guia }}');
            formData.append('placa_registrada', placaRegistrada);
            
            const response = await fetch('/pesaje/verificar_placa_pesaje', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            // Mostrar el resultado
            resultadoPlaca.style.display = 'block';
            
            if (data.success) {
                textoPlacaDetectada.textContent = data.placa_detectada;
                
                if (data.coincide) {
                    placaCoincide.style.display = 'block';
                    placaNoCoincide.style.display = 'none';
                    placaError.style.display = 'none';
                } else {
                    placaCoincide.style.display = 'none';
                    placaNoCoincide.style.display = 'block';
                    placaError.style.display = 'none';
                }
            } else {
                textoErrorPlaca.textContent = data.message;
                placaCoincide.style.display = 'none';
                placaNoCoincide.style.display = 'none';
                placaError.style.display = 'block';
            }
        } catch (error) {
            console.error(error);
            textoErrorPlaca.textContent = 'Error al procesar la verificación de placa';
            resultadoPlaca.style.display = 'block';
            placaCoincide.style.display = 'none';
            placaNoCoincide.style.display = 'none';
            placaError.style.display = 'block';
        } finally {
            // Ocultar el overlay de carga
            mostrarCarga(false);
        }
    });

    // --- Elementos para la sección Pepa ---
    const btnCapturarPepa = document.getElementById('btn_capturar_pepa');
    const inputFotoPepa = document.getElementById('input_foto_pepa');
    const btnRecapturarPepa = document.getElementById('btn_recapturar_pepa');
    const previewContainerPepa = document.getElementById('preview_container_pepa');
    const previewImagePepa = document.getElementById('preview_image_pepa');
    const pesoDetectadoContainerPepa = document.getElementById('peso_detectado_container_pepa');
    const pesoDetectadoSpanPepa = document.getElementById('peso_detectado_pepa');
    const btnValidarFotoPepa = document.getElementById('btn_validacion_foto_pepa');
    const btnProcesarPepa = document.getElementById('btn_procesar_pepa'); // Referencia al nuevo botón
    // -------------------------------------

    // --- Función para mostrar la imagen (sección Pepa) ---
    function mostrarImagenPepa(blob) {
        previewImagePepa.src = URL.createObjectURL(blob);
        previewContainerPepa.style.display = 'block';
        btnCapturarPepa.style.display = 'none';
        inputFotoPepa.parentElement.style.display = 'none';
        btnRecapturarPepa.style.display = 'block';
        pesoDetectadoContainerPepa.style.display = 'none'; // Ocultar resultado previo
        btnProcesarPepa.style.display = 'none'; // Ocultar botón de procesar pepa
        imagenActualPepa = blob;
    }
    // ----------------------------------------------------

    // --- Eventos para la sección Pepa ---
    btnCapturarPepa.addEventListener('click', async () => {
        // Aquí iría la lógica de captura de cámara si se implementa específicamente para Pepa
        // Por ahora, podemos asumir que usa el input de archivo o una lógica similar
        alert('Funcionalidad de cámara aún no implementada para Pepa. Use "Subir Foto".');
    });

    inputFotoPepa.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            mostrarImagenPepa(this.files[0]);
        }
    });

    btnRecapturarPepa.addEventListener('click', function() {
        previewContainerPepa.style.display = 'none';
        btnCapturarPepa.style.display = 'block';
        inputFotoPepa.parentElement.style.display = 'block';
        btnRecapturarPepa.style.display = 'none';
        pesoDetectadoContainerPepa.style.display = 'none';
        btnProcesarPepa.style.display = 'none'; // Ocultar al recapturar
        imagenActualPepa = null;
        pesoDetectadoPepaValor = null; // Limpiar peso guardado
    });
    // -------------------------------------

    // --- Evento para validar foto (sección Pepa) ---
    btnValidarFotoPepa.addEventListener('click', async function() {
        if (!imagenActualPepa) {
            alert('Por favor, capture o suba una imagen para Pepa primero');
            return;
        }
        
        // Mostrar el overlay de carga
        mostrarCarga(true);
        
        try {
            const formData = new FormData();
            // Usamos la imagen específica de la sección Pepa
            formData.append('imagen', imagenActualPepa); 
            formData.append('codigo_guia', '{{ datos.codigo_guia }}');
            
            // Usamos el mismo endpoint de backend que la validación original
            const response = await fetch('/pesaje/procesar_pesaje_directo', { 
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                pesoDetectadoSpanPepa.textContent = data.peso;
                pesoDetectadoContainerPepa.style.display = 'block';
                // Guardar el peso y habilitar el botón de procesar específico de Pepa
                pesoDetectadoPepaValor = data.peso;
                btnProcesarPepa.style.display = 'block'; // Mostrar botón para procesar
                // ¡Importante! NO Habilitar el botón para ir a pesaje neto aquí
                // btnIrPesajeNetoPepa.disabled = true; // Ya no existe
                // No guardamos pesoCapturado global ni habilitamos btnProcesar
                // sapCodeFromValidation = data.codigo_guia_transporte_sap; // Podríamos guardar esto si fuera necesario para Pepa
            } else {
                pesoDetectadoContainerPepa.style.display = 'none';
                // btnIrPesajeNetoPepa.disabled = true; // Ya no existe
                btnProcesarPepa.style.display = 'none'; // Ocultar si falla
                alert(data.message || 'Error al procesar la imagen para Pepa');
            }
        } catch (error) {
            console.error(error);
            alert('Error al procesar la imagen para Pepa: ' + error.message);
            // btnIrPesajeNetoPepa.disabled = true; // Ya no existe
            btnProcesarPepa.style.display = 'none'; // Ocultar en caso de error
        } finally {
            // Ocultar el overlay de carga
            mostrarCarga(false);
        }
    });
    // ------------------------------------------------

    // --- Evento para procesar/guardar peso (sección Pepa) ---
    btnProcesarPepa.addEventListener('click', async function() {
        if (!pesoDetectadoPepaValor || !imagenActualPepa) {
            alert('Error: Falta el peso detectado o la imagen para procesar.');
            return;
        }

        // Mostrar overlay de carga
        const loadingContent = document.querySelector('.loading-content');
        const loadingTitle = loadingContent.querySelector('h2');
        const loadingText = loadingContent.querySelector('p');
        loadingTitle.textContent = 'Guardando peso Pepa...';
        loadingText.textContent = 'Por favor espere.';
        mostrarCarga(true);

        try {
            const formData = new FormData();
            formData.append('codigo_guia', '{{ datos.codigo_guia }}');
            formData.append('peso_bruto', pesoDetectadoPepaValor);
            formData.append('imagen_pesaje', imagenActualPepa);
            // Indicador para el backend
            formData.append('proceso_pepa', 'true'); 

            // Llamada al NUEVO endpoint del backend
            const response = await fetch('/pesaje/registrar_y_marcar_pepa', { 
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success && data.redirect_url) {
                // Redirigir a la página de resultados
                window.location.href = data.redirect_url;
            } else {
                alert(data.message || 'Error al guardar el peso Pepa.');
            }
        
        } catch (error) {
            console.error('Error al procesar peso Pepa:', error);
            alert('Error al procesar el peso Pepa: ' + error.message);
        } finally {
            // Ocultar el overlay de carga y restaurar texto
            mostrarCarga(false);
            loadingTitle.textContent = 'Procesando validación...'; // Restaurar texto original por si acaso
            loadingText.textContent = 'Por favor espere mientras validamos la foto.';
        }
    });
    // -------------------------------------------------------

    // --- Toggle Visibility Buttons (Añadir lógica) ---
    const toggleFotosSoporteBtn = document.getElementById('toggle_fotos_soporte');
    const contenedorFotosSoporte = document.getElementById('contenedor_fotos_soporte');
    const toggleVerificacionPlacaBtn = document.getElementById('toggle_verificacion_placa');
    const contenedorVerificacionPlaca = document.getElementById('contenedor_verificacion_placa');

    if (toggleFotosSoporteBtn && contenedorFotosSoporte) {
        toggleFotosSoporteBtn.addEventListener('click', () => {
            const isHidden = contenedorFotosSoporte.style.display === 'none';
            contenedorFotosSoporte.style.display = isHidden ? 'block' : 'none';
            toggleFotosSoporteBtn.innerHTML = isHidden ? '<i class="fas fa-eye-slash me-1"></i> Ocultar' : '<i class="fas fa-eye me-1"></i> Mostrar';
        });
    }

    if (toggleVerificacionPlacaBtn && contenedorVerificacionPlaca) {
        toggleVerificacionPlacaBtn.addEventListener('click', () => {
            const isHidden = contenedorVerificacionPlaca.style.display === 'none';
            contenedorVerificacionPlaca.style.display = isHidden ? 'block' : 'none';
            toggleVerificacionPlacaBtn.innerHTML = isHidden ? '<i class="fas fa-eye-slash me-1"></i> Ocultar' : '<i class="fas fa-eye me-1"></i> Mostrar';
        });
    }
    // ---------------------------------

    // --- Screen Capture Logic ---
    const btnCapturarPantalla = document.getElementById('btn_capturar_pantalla');
    const btnCapturarPantallaPepa = document.getElementById('btn_capturar_pantalla_pepa'); // Botón para Pepa

    // Modificamos startScreenCapture para aceptar la función de callback de visualización
    async function startScreenCapture(displayCallback) {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
            alert("La captura de pantalla no está soportada por este navegador.");
            return;
        }

        let captureStream = null;
        const videoElement = document.createElement('video');
        const canvasElement = document.createElement('canvas');
        const context = canvasElement.getContext('2d');

        try {
            captureStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });

            videoElement.srcObject = captureStream;
            videoElement.play();

            // Esperar a que el video tenga suficientes datos para obtener dimensiones
            videoElement.onloadedmetadata = () => {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;

                // Dibujar el fotograma actual en el canvas
                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

                // Detener la captura de pantalla
                captureStream.getTracks().forEach(track => track.stop());

                // Convertir canvas a Blob
                canvasElement.toBlob(blob => {
                    if (blob) {
                        // Llamar al callback proporcionado para mostrar la imagen
                        displayCallback(blob); 
                    } else {
                        alert("Error al crear la imagen desde la captura de pantalla.");
                    }
                }, 'image/png');
            };

        } catch (err) {
            console.error("Error en captura de pantalla: ", err);
            alert(`Error al capturar pantalla: ${err.message}`);
            if (captureStream) {
                 captureStream.getTracks().forEach(track => track.stop());
            }
        }
    }

    // Listener para el botón original (Pesaje Soporte Foto)
    if (btnCapturarPantalla) {
        btnCapturarPantalla.addEventListener('click', () => startScreenCapture(mostrarImagen));
    }

    // Listener para el nuevo botón (Pesaje Pepa)
    if (btnCapturarPantallaPepa) {
        btnCapturarPantallaPepa.addEventListener('click', () => startScreenCapture(mostrarImagenPepa));
    }
    // -------------------------

}); // Fin de DOMContentLoaded
</script>
{% endblock %}